<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Star Runner 3D - Arwing SNES Edition</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; touch-action: none; color: white; }
        #interface { position: absolute; top: 20px; left: 20px; z-index: 10; pointer-events: none; display: none; }
        .stat-box { background: rgba(0, 0, 0, 0.8); padding: 10px 20px; border-radius: 5px; border-left: 5px solid #00d4ff; margin-bottom: 10px; }
        #target-display { font-size: 24px; color: #00d4ff; font-weight: bold; }
        #touch-controls { position: fixed; inset: 0; display: flex; z-index: 5; }
        .touch-zone { flex: 1; height: 100%; }
        
        .overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(0, 0, 0, 0.95); padding: 40px; border: 2px solid #00d4ff; z-index: 100; min-width: 300px; }
        button { padding: 15px 40px; font-size: 20px; cursor: pointer; background: transparent; color: #00d4ff; border: 2px solid #00d4ff; font-weight: bold; margin-top: 25px; transition: 0.2s; border-radius: 8px; pointer-events: auto; }
        button:hover { background: #00d4ff; color: black; }
        
        #fireworks-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 1500; display: none; }
        
        #game-over { position: fixed; inset: 0; background: black; display: none; z-index: 1000; overflow: hidden; }
        .star-wars-window { position: absolute; width: 100%; height: 100%; -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 100%); mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 100%); }
        .crawl-container { position: absolute; bottom: 0; left: 50%; width: 300%; height: 100%; margin-left: -150%; perspective: 350px; perspective-origin: 50% 100%; }
        #crawl-text { position: absolute; width: 70%; left: 15%; top: 110%; color: #feda4a; font-family: "Franklin Gothic Medium", Arial, sans-serif; text-align: center; font-weight: 900; line-height: 1.1; transform: rotateX(20deg); transform-origin: 50% 100%; opacity: 0; }
        
        /* Vitesse acc√©l√©r√©e : 12s au lieu de 25s */
        .animate-crawl { opacity: 1 !important; animation: starwars-ascend 12s linear forwards; }
        @keyframes starwars-ascend { 0% { top: 110%; transform: rotateX(20deg) translateY(0) scale(1.3); } 100% { top: -600%; transform: rotateX(20deg) translateY(-2000px) scale(0.01); } }
        #crawl-text p { margin-bottom: 1.5em; font-size: 15vw; letter-spacing: 2px; text-transform: uppercase; }
        
        #victory-screen { position: fixed; inset: 0; background: radial-gradient(circle, #001a33 0%, #000 100%); display: none; z-index: 2000; text-align: center; padding-top: 10vh; }
        .trophy { font-size: 140px; animation: bounce 2s infinite; display: block; filter: drop-shadow(0 0 20px gold); }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-30px); } }
    </style>
</head>
<body>

    <canvas id="fireworks-canvas"></canvas>
    
    <div id="touch-controls">
        <div id="left-zone" class="touch-zone"></div>
        <div id="right-zone" class="touch-zone"></div>
    </div>

    <div id="start-screen" class="overlay">
        <h1>STAR RUNNER</h1>
        <p>MISSION: 12 AUDIO INTERCEPTIONS.</p>
        <button id="btn-start">START MISSION</button>
    </div>

    <div id="interface">
        <div class="stat-box"><div id="round-display">ROUND: 1 / 12</div></div>
        <div id="target-display">PREPARING...</div>
    </div>

    <div id="game-over">
        <div class="star-wars-window">
            <div class="crawl-container">
                <div id="crawl-text">
                    <p style="font-size: 25vw; color: #feda4a; margin-bottom: 0.8em;">FAILURE</p>
                    <p>The signal was lost</p>
                    <p>Base did not receive code:</p>
                    <p style="font-size: 30vw; color: white; text-shadow: 0 0 50px #00d4ff;" id="final-target"></p>
                    <p>Mission Terminated</p>
                    <p style="margin-top: 2em; font-size: 16vw;">MAY THE FORCE BE WITH YOU</p>
                </div>
            </div>
        </div>
        <button style="position:absolute; bottom:5%; left:50%; transform:translateX(-50%); z-index:1100;" onclick="location.reload()">TRY AGAIN</button>
    </div>

    <div id="victory-screen">
        <span class="trophy">üèÜ</span>
        <h1 style="color: gold; font-size: 4em; text-shadow: 0 0 20px gold;">MISSION COMPLETE</h1>
        <button style="border-color: gold; color: gold;" onclick="location.reload()">PLAY AGAIN</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const apiKey = "";
        let scene, camera, renderer, ship, flameInner, flameOuter, starsGeometry;
        let obstacles = [];
        let currentRound = 1, totalRounds = 12, isGameOver = false, gameActive = false, targetNumber = null;
        let keyLeft = false, keyRight = false, currentCubeSpeed = 0.35;
        let maxAnisotropy = 1;

        // --- Syst√®me de Particules Canvas ---
        const fwCanvas = document.getElementById('fireworks-canvas');
        const fwCtx = fwCanvas.getContext('2d');
        let particles = [];

        function resizeFw() { 
            fwCanvas.width = window.innerWidth; 
            fwCanvas.height = window.innerHeight; 
        }
        window.addEventListener('resize', resizeFw); 
        resizeFw();

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 6 + 4;
                this.vx = Math.cos(angle) * velocity;
                this.vy = Math.sin(angle) * velocity;
                this.opacity = 1;
                this.friction = 0.95;
                this.gravity = 0.12;
            }
            update() {
                this.vx *= this.friction;
                this.vy *= this.friction;
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;
                this.opacity -= 0.012;
            }
            draw() {
                fwCtx.globalAlpha = Math.max(0, this.opacity);
                fwCtx.fillStyle = this.color;
                fwCtx.beginPath();
                fwCtx.arc(this.x, this.y, 3, 0, Math.PI * 2);
                fwCtx.fill();
            }
        }

        function spawnFirework() {
            const x = Math.random() * fwCanvas.width;
            const y = Math.random() * fwCanvas.height * 0.4;
            const color = `hsl(${Math.random() * 360}, 100%, 65%)`;
            for(let i=0; i<80; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        function updateParticles() {
            fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
            for(let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].draw();
                if(particles[i].opacity <= 0) particles.splice(i, 1);
            }
        }

        // --- Logique du Jeu ---

        function getNumberWord(n) {
            const units = ["zero", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen", "sixteen", "seventeen", "eighteen", "nineteen"];
            const tens = ["", "", "twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty", "ninety"];
            if (n < 20) return units[n];
            return tens[Math.floor(n / 10)] + (n % 10 !== 0 ? "-" + units[n % 10] : "");
        }

        async function announceNumber(num) {
            const word = getNumberWord(num);
            try {
                // Requ√™te Gemini TTS : Uniquement le mot
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: word }] }],
                        generationConfig: { 
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                        }
                    })
                });
                const data = await resp.json();
                const b64 = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (b64) {
                    const audio = new Audio("data:audio/mp3;base64," + b64);
                    await audio.play();
                }
            } catch (e) {
                const utter = new SpeechSynthesisUtterance(word);
                utter.lang = 'en-US'; 
                window.speechSynthesis.speak(utter);
            }
        }

        function createArwing() {
            const group = new THREE.Group();
            const matWhite = new THREE.MeshPhongMaterial({ color: 0xeeeeee, flatShading: true });
            const matBlue = new THREE.MeshPhongMaterial({ color: 0x1e40af, flatShading: true });
            const matRed = new THREE.MeshPhongMaterial({ color: 0xb91c1c, flatShading: true });
            const matGlass = new THREE.MeshPhongMaterial({ color: 0x0ea5e9, transparent: true, opacity: 0.7 });
            
            // Fuselage principal
            const bodyGeo = new THREE.CylinderGeometry(0, 0.45, 3.2, 4);
            const body = new THREE.Mesh(bodyGeo, matWhite);
            body.rotation.x = Math.PI / 2;
            group.add(body);

            // Cockpit
            const cockGeo = new THREE.BoxGeometry(0.3, 0.3, 0.7);
            const cockpit = new THREE.Mesh(cockGeo, matGlass);
            cockpit.position.set(0, 0.22, -0.4);
            group.add(cockpit);

            // Ailes plus petites et plus allong√©es (effet Star Fox)
            const wingShape = new THREE.Shape();
            wingShape.moveTo(0, 0);
            wingShape.lineTo(1.8, 0.2); // Moins large
            wingShape.lineTo(1.5, 2.2); // Plus long vers l'arri√®re
            wingShape.lineTo(0, 1.2);
            wingShape.lineTo(0, 0);

            const wingGeo = new THREE.ExtrudeGeometry(wingShape, { depth: 0.05, bevelEnabled: false });
            
            const rightWing = new THREE.Mesh(wingGeo, matBlue);
            rightWing.rotation.x = Math.PI/2;
            rightWing.rotation.y = -0.15; // L√©g√®re inclinaison vers le bas
            rightWing.position.set(0.2, 0, 0.3);
            group.add(rightWing);

            const leftWing = new THREE.Mesh(wingGeo, matBlue);
            leftWing.rotation.x = Math.PI/2;
            leftWing.rotation.y = 0.15;
            leftWing.scale.x = -1;
            leftWing.position.set(-0.2, 0, 0.3);
            group.add(leftWing);

            // Flammes r√©acteurs
            flameInner = new THREE.Mesh(new THREE.ConeGeometry(0.15, 1.2, 6), new THREE.MeshBasicMaterial({ color: 0xffff00 }));
            flameInner.rotation.x = -Math.PI/2; flameInner.position.z = 1.6; 
            group.add(flameInner);

            flameOuter = new THREE.Mesh(new THREE.ConeGeometry(0.35, 2.2, 6), new THREE.MeshBasicMaterial({ color: 0xff4400, transparent: true, opacity: 0.4 }));
            flameOuter.rotation.x = -Math.PI/2; flameOuter.position.z = 2.0; 
            group.add(flameOuter);

            return group;
        }

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 4, 10); 
            camera.lookAt(0, 1.5, -5);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);
            
            maxAnisotropy = renderer.capabilities.getMaxAnisotropy();

            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const light = new THREE.DirectionalLight(0xffffff, 1); light.position.set(5, 10, 5); scene.add(light);
            
            ship = createArwing(); 
            ship.position.y = 1.3; 
            scene.add(ship);
            
            const grid = new THREE.GridHelper(600, 80, 0x0044ff, 0x001133);
            scene.add(grid);
            
            starsGeometry = new THREE.BufferGeometry();
            const starPos = []; 
            for(let i=0; i<1500; i++) {
                starPos.push((Math.random()-0.5)*180, (Math.random()-0.5)*120, -Math.random()*250);
            }
            starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
            scene.add(new THREE.Points(starsGeometry, new THREE.PointsMaterial({color: 0xffffff, size: 0.15})));

            document.getElementById('btn-start').onclick = start;
            
            // Contr√¥les tactiles am√©lior√©s
            const lZone = document.getElementById('left-zone');
            const rZone = document.getElementById('right-zone');
            
            lZone.onpointerdown = (e) => { e.preventDefault(); keyLeft = true; };
            lZone.onpointerup = () => keyLeft = false;
            rZone.onpointerdown = (e) => { e.preventDefault(); keyRight = true; };
            rZone.onpointerup = () => keyRight = false;
            
            window.onkeydown = (e) => { 
                if(e.key === "ArrowLeft") keyLeft = true; 
                if(e.key === "ArrowRight") keyRight = true; 
            };
            window.onkeyup = (e) => { 
                if(e.key === "ArrowLeft") keyLeft = false; 
                if(e.key === "ArrowRight") keyRight = false; 
            };

            animate();
        }

        function start() {
            gameActive = true; 
            document.getElementById('start-screen').style.display = 'none'; 
            document.getElementById('interface').style.display = 'block'; 
            nextRound(); 
        }

        async function nextRound() {
            if (currentRound > totalRounds) { 
                victory(); 
                return; 
            }
            document.getElementById('round-display').innerText = `ROUND: ${currentRound} / ${totalRounds}`;
            document.getElementById('target-display').innerText = "INCOMING SIGNAL...";
            
            obstacles.forEach(o => scene.remove(o)); 
            obstacles = [];
            
            targetNumber = Math.floor(Math.random() * 99) + 1;
            await announceNumber(targetNumber);
            
            document.getElementById('target-display').innerText = "INTERCEPT TARGET";
            spawnWave();
        }

        function spawnWave() {
            // Lanes plus √©cart√©es (7 au lieu de 5)
            const lanes = [-7, 0, 7], winIdx = Math.floor(Math.random()*3);
            lanes.forEach((x, i) => {
                const val = (i === winIdx) ? targetNumber : Math.floor(Math.random()*99)+1;
                const canv = document.createElement('canvas'); canv.width = 256; canv.height = 256; 
                const ctx = canv.getContext('2d');
                ctx.fillStyle = '#051025'; ctx.fillRect(0,0,256,256);
                ctx.strokeStyle = '#00d4ff'; ctx.lineWidth = 15; ctx.strokeRect(10,10,236,236);
                ctx.fillStyle = '#ffffff'; ctx.font = 'bold 140px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(val, 128, 128);
                
                const tex = new THREE.CanvasTexture(canv);
                tex.anisotropy = maxAnisotropy;
                const box = new THREE.Mesh(new THREE.BoxGeometry(3.5, 3.5, 3.5), new THREE.MeshPhongMaterial({ map: tex }));
                box.position.set(x, 1.75, -120); 
                box.userData = { win: i === winIdx };
                scene.add(box); 
                obstacles.push(box);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (particles.length > 0) updateParticles();

            if(!gameActive || isGameOver) { 
                renderer.render(scene, camera); 
                return; 
            }
            
            const p = 1.0 + Math.sin(Date.now() * 0.05) * 0.15;
            flameInner.scale.set(p, 0.8 + Math.random()*0.4, p);
            flameOuter.scale.set(p*1.2, 0.6 + Math.random()*0.8, p*1.2);
            
            const starArr = starsGeometry.attributes.position.array;
            for(let i=0; i < starArr.length; i+=3) {
                starArr[i+2] += currentCubeSpeed * 4;
                if(starArr[i+2] > 10) starArr[i+2] = -240;
            }
            starsGeometry.attributes.position.needsUpdate = true;

            let targetRotZ = 0;
            if(keyLeft && ship.position.x > -10) { ship.position.x -= 0.5; targetRotZ = 0.6; }
            else if(keyRight && ship.position.x < 10) { ship.position.x += 0.5; targetRotZ = -0.6; }
            ship.rotation.z += (targetRotZ - ship.rotation.z) * 0.1;
            camera.position.x += (ship.position.x*0.3 - camera.position.x) * 0.05;
            
            for(let i=obstacles.length-1; i>=0; i--) {
                const b = obstacles[i];
                b.position.z += currentCubeSpeed;
                b.rotation.y += 0.02;
                
                if(ship.position.distanceTo(b.position) < 2.5) {
                    if(b.userData.win) { 
                        currentRound++; 
                        currentCubeSpeed += 0.03; 
                        nextRound(); 
                    } else { 
                        die(); 
                    }
                    break;
                }
                if(b.position.z > 15) {
                    if(b.userData.win) die();
                    scene.remove(b);
                    obstacles.splice(i, 1);
                }
            }

            renderer.render(scene, camera);
        }

        function die() { 
            isGameOver = true; 
            document.getElementById('final-target').innerText = targetNumber; 
            document.getElementById('game-over').style.display = 'block'; 
            setTimeout(() => { document.getElementById('crawl-text').classList.add('animate-crawl'); }, 100);
        }

        function victory() { 
            isGameOver = true; 
            document.getElementById('victory-screen').style.display = 'block'; 
            document.getElementById('fireworks-canvas').style.display = 'block'; 
            
            const launch = () => { 
                if(isGameOver) { 
                    spawnFirework(); 
                    setTimeout(launch, 600); 
                } 
            }; 
            launch(); 
        }

        window.onload = init;
    </script>
</body>
</html>
